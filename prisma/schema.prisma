// CrownDesk V2 - Prisma Schema
// Based on plan.txt Section 20 Database Schemas
// Implements multi-tenant architecture with RLS support

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), uuidOssp(map: "uuid-ossp")]
}

// ===========================================
// Section 20.1: Tenancy & Users
// ===========================================

model Tenant {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clerkOrgId           String   @unique @map("clerk_org_id") // Clerk organization ID
  name                 String
  status               TenantStatus @default(active)
  stripeCustomerId     String?  @map("stripe_customer_id")
  stripeSubscriptionId String?  @map("stripe_subscription_id")
  subscriptionPlan     SubscriptionPlan @default(starter) @map("subscription_plan")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  users        User[]
  patients     Patient[]
  families     Family[]
  providers    Provider[]
  operatories  Operatory[]
  appointments Appointment[]
  approvals    Approval[]
  auditLogs    AuditLog[]
  documents    Document[]
  aiInsights   AiInsight[]
  insurancePolicies InsurancePolicy[]
  eligibilityRequests EligibilityRequest[]
  pmsMappings  PmsMapping[]
  usageLedger  UsageLedger[]
  phoneNumbers PhoneNumber[]
  agentConfigs AgentConfig[]
  automationRuns AutomationRun[]
  serviceApiKeys ServiceApiKey[]
  preAuthorizations PreAuthorization[]
  trainingExamples TrainingExample[]

  @@index([subscriptionPlan])
  @@map("tenants")
}

model User {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clerkUserId String   @unique @map("clerk_user_id")
  tenantId    String   @map("tenant_id") @db.Uuid
  role        UserRole @default(frontdesk)
  email       String
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approvals      Approval[]      @relation("ApprovedBy")
  auditLogs      AuditLog[]
  sessions       Session[]
  securityEvents SecurityEvent[]
  userTraining   UserTraining[]
  createdApiKeys ServiceApiKey[] @relation("CreatedBy")

  @@index([tenantId])
  @@map("users")
}

// ===========================================
// Section: Session Management (HIPAA Compliance)
// ===========================================

model Session {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  tokenHash    String   @unique @map("token_hash") // Last 16 chars of JWT for identification
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  lastActivity DateTime @map("last_activity")
  expiresAt    DateTime @map("expires_at")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([lastActivity])
  @@index([isActive])
  @@map("sessions")
}

// ===========================================
// Section: Security Events (Monitoring & Alerts)
// ===========================================

model SecurityEvent {
  id         String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String?           @map("tenant_id") @db.Uuid
  userId     String?           @map("user_id") @db.Uuid
  eventType  SecurityEventType @map("event_type")
  severity   Severity
  ipAddress  String?           @map("ip_address")
  userAgent  String?           @map("user_agent")
  metadata   Json?
  createdAt  DateTime          @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([eventType])
  @@index([severity])
  @@map("security_events")
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  SESSION_TIMEOUT
  SESSION_REVOKED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  PASSWORD_RESET
  MFA_ENABLED
  MFA_DISABLED
  PERMISSION_DENIED
  SUSPICIOUS_ACTIVITY
  RATE_LIMIT_EXCEEDED
  TOKEN_REFRESH
  ORG_SWITCH
}

enum Severity {
  low
  medium
  high
  critical
}

// ===========================================
// Section: Permission System (Granular RBAC)
// ===========================================

model Permission {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String   @unique // e.g., 'read:patients', 'write:claims'
  description String?
  category    String   // e.g., 'patients', 'billing', 'appointments'
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@index([category])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  role         UserRole
  permissionId String   @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@map("role_permissions")
}

// ===========================================
// Section: HIPAA Training Compliance
// ===========================================

model UserTraining {
  id             String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId         String       @map("user_id") @db.Uuid
  trainingType   TrainingType @map("training_type")
  completedAt    DateTime     @map("completed_at")
  expiresAt      DateTime     @map("expires_at")
  certificateUrl String?      @map("certificate_url")
  createdAt      DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_training")
}

enum TrainingType {
  HIPAA_SECURITY
  HIPAA_PRIVACY
  PHI_HANDLING
  DATA_BREACH_RESPONSE
  ANNUAL_REFRESHER
}

// ===========================================
// Section: Service API Keys (AI Agents, Webhooks)
// ===========================================

model ServiceApiKey {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  name            String    // e.g., "ElevenLabs AI Receptionist"
  keyHash         String    @unique @map("key_hash") // SHA-256 hash of API key
  serviceType     String    @map("service_type") // "ai_agent", "webhook", "integration"
  description     String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  expiresAt       DateTime? @map("expires_at")
  lastUsedAt      DateTime? @map("last_used_at")
  usageCount      Int       @default(0) @map("usage_count")
  createdByUserId String?   @map("created_by_user_id") @db.Uuid

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User?  @relation("CreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([keyHash])
  @@index([isActive])
  @@map("service_api_keys")
}

enum TenantStatus {
  active
  suspended
  cancelled
  pending
}

enum SubscriptionPlan {
  free
  starter
  professional
  enterprise
}

enum UserRole {
  admin
  frontdesk
  billing
  manager
}

// ===========================================
// Section 20.2: Patients & Appointments
// ===========================================

model Patient {
  id           String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String        @map("tenant_id") @db.Uuid
  pmsSource    PmsSource     @default(manual) @map("pms_source")
  pmsPatientId String?       @map("pms_patient_id")
  firstName    String        @map("first_name")
  lastName     String        @map("last_name")
  middleName   String?       @map("middle_name")
  preferredName String?      @map("preferred_name")
  dob          DateTime      @db.Date
  gender       Gender?
  ssn          String?       // Encrypted
  phone        String?
  mobilePhone  String?       @map("mobile_phone")
  workPhone    String?       @map("work_phone")
  email        String?
  address      Json?         // PatientAddress
  preferredContact PreferredContact @default(phone) @map("preferred_contact")
  
  // Emergency Contact
  emergencyContactName     String? @map("emergency_contact_name")
  emergencyContactPhone    String? @map("emergency_contact_phone")
  emergencyContactRelation String? @map("emergency_contact_relation")
  
  // Clinical
  medicalAlerts     String[] @map("medical_alerts")
  allergies         Json?    // Allergy[]
  medications       Json?    // Medication[]
  medicalConditions String[] @map("medical_conditions")
  
  // Family
  familyId               String?  @map("family_id") @db.Uuid
  isPrimaryAccountHolder Boolean  @default(false) @map("is_primary_account_holder")
  guarantorId            String?  @map("guarantor_id") @db.Uuid
  
  // Status
  status       PatientStatus @default(active)
  lastVisit    DateTime?     @map("last_visit")
  nextAppointment DateTime?  @map("next_appointment")
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  family            Family?            @relation("FamilyMembers", fields: [familyId], references: [id], onDelete: SetNull)
  guarantor         Patient?           @relation("Guarantor", fields: [guarantorId], references: [id], onDelete: SetNull)
  dependents        Patient[]          @relation("Guarantor")
  appointments      Appointment[]
  insurancePolicies InsurancePolicy[]
  documents         Document[]
  eligibilityRequests EligibilityRequest[]
  claims            Claim[]
  treatmentPlans    TreatmentPlan[]
  invoices          Invoice[]
  callRecords       CallRecord[]
  completedProcedures CompletedProcedure[]
  preAuthorizations PreAuthorization[]

  @@unique([pmsSource, pmsPatientId])
  @@index([tenantId])
  @@index([familyId])
  @@index([status])
  @@map("patients")
}

model Family {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String?  // Optional family name like "The Smith Family"
  guarantorId String?  @map("guarantor_id") @db.Uuid // Primary bill payer
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  members Patient[] @relation("FamilyMembers")

  @@index([tenantId])
  @@map("families")
}

// Provider model for dental providers
model Provider {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  pmsProviderId   String?      @map("pms_provider_id")
  firstName       String       @map("first_name")
  lastName        String       @map("last_name")
  title           String?      // Dr., etc.
  npi             String?      // National Provider Identifier
  license         String?      // State license number
  specialty       ProviderSpecialty @default(general_dentist)
  email           String?
  phone           String?
  color           String?      // For calendar display
  isActive        Boolean      @default(true) @map("is_active")
  workingHours    Json?        @map("working_hours") // ProviderWorkingHours
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  operatories  Operatory[]   // Operatories where this provider is default
  completedProcedures CompletedProcedure[]

  @@unique([tenantId, npi])
  @@index([tenantId])
  @@index([isActive])
  @@map("providers")
}

// Operatory model for dental chairs/rooms
model Operatory {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  pmsOperatoryId String? @map("pms_operatory_id")
  name         String   // e.g., "Chair 1", "Hygiene Room A"
  shortName    String?  @map("short_name") // e.g., "Op1"
  location     String?  // Physical location in office
  color        String?  // For calendar display
  description  String?
  isActive     Boolean  @default(true) @map("is_active")
  isHygiene    Boolean  @default(false) @map("is_hygiene") // Hygiene-only operatory
  equipment    String[] @default([]) // Array of equipment available
  defaultProviderId String? @map("default_provider_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultProvider Provider?   @relation(fields: [defaultProviderId], references: [id], onDelete: SetNull)
  appointments Appointment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@index([defaultProviderId])
  @@map("operatories")
}

enum Gender {
  male
  female
  other
  unknown
}

enum PreferredContact {
  email
  phone
  sms
  mail
}

enum PatientStatus {
  active
  inactive
  deceased
  archived
}

enum ProviderSpecialty {
  general_dentist
  orthodontist
  periodontist
  endodontist
  oral_surgeon
  prosthodontist
  pediatric_dentist
  hygienist
}

model Appointment {
  id               String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String            @map("tenant_id") @db.Uuid
  patientId        String            @map("patient_id") @db.Uuid
  providerId       String?           @map("provider_id") @db.Uuid
  operatoryId      String?           @map("operatory_id") @db.Uuid
  pmsAppointmentId String?           @map("pms_appointment_id")
  provider         String            // Legacy: provider name (keep for compatibility)
  operatory        String?           // Legacy: operatory name
  startTime        DateTime          @map("start_time")
  endTime          DateTime          @map("end_time")
  duration         Int               @default(30) // minutes
  appointmentType  AppointmentType   @default(treatment) @map("appointment_type")
  status           AppointmentStatus @default(scheduled)
  chiefComplaint   String?           @map("chief_complaint")
  notes            String?
  procedureCodes   String[]          @map("procedure_codes")
  
  // Confirmation
  confirmedAt      DateTime?         @map("confirmed_at")
  confirmedBy      String?           @map("confirmed_by")
  remindersSent    Int               @default(0) @map("reminders_sent")
  
  // Check-in/out
  arrivedAt        DateTime?         @map("arrived_at")
  seatedAt         DateTime?         @map("seated_at")
  completedAt      DateTime?         @map("completed_at")
  
  // Family Linking
  familyAppointmentId String?        @map("family_appointment_id") @db.Uuid
  
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  createdBy        String?           @map("created_by")

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient    Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  providerRef Provider?  @relation(fields: [providerId], references: [id], onDelete: SetNull)
  operatoryRef Operatory? @relation(fields: [operatoryId], references: [id], onDelete: SetNull)
  callRecords CallRecord[]

  @@index([tenantId, startTime])
  @@index([patientId])
  @@index([providerId])
  @@index([operatoryId])
  @@index([status])
  @@index([familyAppointmentId])
  @@map("appointments")
}

enum AppointmentType {
  new_patient
  recall
  treatment
  emergency
  consultation
  follow_up
  hygiene
  periodontal
  restorative
  endodontic
  oral_surgery
  orthodontic
}

enum PmsSource {
  open_dental
  dentrix
  eaglesoft
  manual
}

enum AppointmentStatus {
  scheduled
  confirmed
  checked_in
  in_progress
  completed
  cancelled
  no_show
}

// ===========================================
// Section 20.3: Insurance & Billing
// ===========================================

model InsurancePolicy {
  id                 String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  patientId          String             @map("patient_id") @db.Uuid
  tenantId           String             @map("tenant_id") @db.Uuid
  payerName          String             @map("payer_name")
  payerId            String?            @map("payer_id")
  planName           String?            @map("plan_name")
  memberId           String             @map("member_id")
  groupNumber        String?            @map("group_number")
  subscriberRelation SubscriberRelation @default(self) @map("subscriber_relation")
  effectiveDate      DateTime?          @map("effective_date") @db.Date
  terminationDate    DateTime?          @map("termination_date") @db.Date
  isPrimary          Boolean            @default(true) @map("is_primary")
  lastVerified       DateTime?          @map("last_verified")
  lastVerificationStatus String?        @map("last_verification_status")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient             Patient              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  eligibilityRequests EligibilityRequest[]
  claims              Claim[]
  preAuthorizations   PreAuthorization[]

  @@index([patientId])
  @@index([tenantId])
  @@map("insurance_policies")
}

model EligibilityRequest {
  id                String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  patientId         String            @map("patient_id") @db.Uuid
  tenantId          String            @map("tenant_id") @db.Uuid
  insurancePolicyId String            @map("insurance_policy_id") @db.Uuid
  requestedAt       DateTime          @default(now()) @map("requested_at")
  status            EligibilityStatus @default(pending)
  stediRequestId    String?           @map("stedi_request_id")
  requestPayload    Json?             @map("request_payload")
  createdAt         DateTime          @default(now()) @map("created_at")

  // Relations
  tenant            Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient           Patient              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  insurancePolicy   InsurancePolicy      @relation(fields: [insurancePolicyId], references: [id], onDelete: Cascade)
  eligibilityResponse EligibilityResponse?

  @@index([patientId])
  @@index([status])
  @@index([tenantId])
  @@map("eligibility_requests")
}

model EligibilityResponse {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eligibilityRequestId String   @unique @map("eligibility_request_id") @db.Uuid
  rawPayload           Json     @map("raw_payload")
  normalizedSummary    Json     @map("normalized_summary") // EligibilityNormalizedSummary
  receivedAt           DateTime @default(now()) @map("received_at")

  // Relations
  eligibilityRequest EligibilityRequest @relation(fields: [eligibilityRequestId], references: [id], onDelete: Cascade)

  @@map("eligibility_responses")
}

enum SubscriberRelation {
  self
  spouse
  child
  other
}

enum EligibilityStatus {
  pending
  verified
  failed
  expired
  not_found
}

// ===========================================
// Section 20.3.5: Pre-Authorization
// ===========================================

model PreAuthorization {
  id                   String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String       @map("tenant_id") @db.Uuid
  patientId            String       @map("patient_id") @db.Uuid
  insurancePolicyId    String       @map("insurance_policy_id") @db.Uuid
  treatmentPlanId      String?      @map("treatment_plan_id") @db.Uuid
  
  // Procedures requiring PA
  procedures           Json         // Array of {cdtCode, description, toothNumber, fee, quantity}
  
  // Narrative
  narrative            String?      @db.Text // Clinical narrative text
  narrativeSource      String       @default("manual") @map("narrative_source") // 'manual' | 'ai_generated'
  
  // X12 278 Transaction Fields (per HIPAA EDI requirements)
  requestTypeCode      String?      @map("request_type_code") // 'HS'=Health Services, 'AR'=Admission Review
  serviceTypeCode      String?      @map("service_type_code") // '35'=Dental Care (X12 standard)
  certificationTypeCode String?     @map("certification_type_code") // 'I'=Initial, 'R'=Renewal, 'A'=Appeal
  levelOfServiceCode   String?      @map("level_of_service_code") // 'U'=Urgent, 'E'=Elective
  
  // Certification Period (from 278 response)
  certificationStartDate DateTime?  @map("certification_start_date") @db.Date
  certificationEndDate DateTime?    @map("certification_end_date") @db.Date
  certifiedQuantity    Int?         @map("certified_quantity") // Number of services/visits approved
  
  // Submission
  submissionMethod     String?      @map("submission_method") // 'electronic_278' | 'fax' | 'portal' | 'mail'
  submissionDate       DateTime?    @map("submission_date")
  stediTransactionId   String?      @map("stedi_transaction_id") // If submitted via Stedi 278
  
  // Status tracking
  status               PAStatus     @default(draft)
  payerReferenceNumber String?      @map("payer_reference_number")
  approvalDate         DateTime?    @map("approval_date")
  denialDate           DateTime?    @map("denial_date")
  denialReason         String?      @map("denial_reason") @db.Text
  denialCode           String?      @map("denial_code") // HIPAA Rejection Reason Code
  expirationDate       DateTime?    @map("expiration_date") @db.Date
  
  // Approved details
  approvedProcedures   Json?        @map("approved_procedures") // Subset that was approved
  approvedAmount       Decimal?     @map("approved_amount") @db.Decimal(10, 2)
  
  // Urgency & Follow-up (per CMS 2025 requirements)
  isUrgent             Boolean      @default(false) @map("is_urgent") // CMS: 72-hour response required
  followUpDate         DateTime?    @map("follow_up_date") @db.Date
  
  // Creator tracking
  createdBy            String       @map("created_by") @db.Uuid
  createdByType        String       @default("user") @map("created_by_type") // 'user' | 'ai_agent' | 'automation'
  
  // Timestamps
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  // Relations
  tenant               Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient              Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  insurancePolicy      InsurancePolicy  @relation(fields: [insurancePolicyId], references: [id], onDelete: Cascade)
  treatmentPlan        TreatmentPlan?   @relation(fields: [treatmentPlanId], references: [id], onDelete: SetNull)
  attachments          Attachment[]
  documents            Document[]       @relation("PreAuthDocuments")
  claims               Claim[]

  @@index([tenantId, status])
  @@index([patientId])
  @@index([insurancePolicyId])
  @@index([stediTransactionId])
  @@map("pre_authorizations")
}

enum PAStatus {
  draft              // Initial creation
  pending_approval   // Waiting for internal approval
  submitted          // Sent to payer
  pending_payer      // Waiting for payer response
  approved           // Payer approved
  denied             // Payer denied
  expired            // Approval expired
  cancelled          // Cancelled by practice
}

// ===========================================
// Section 20.4: Approvals & Audit
// ===========================================

model Approval {
  id              String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String             @map("tenant_id") @db.Uuid
  entityType      ApprovalEntityType @map("entity_type")
  entityId        String             @map("entity_id") @db.Uuid
  field           String?            // Field being changed
  oldValue        Json?              @map("old_value") // Previous value
  newValue        Json?              @map("new_value") // New value
  beforeState     Json               @map("before_state")
  afterState      Json               @map("after_state")
  
  // Source tracking (who/what created this approval request)
  sourceType              String   @default("user") @map("source_type") // 'user' | 'ai_agent' | 'automation' | 'external'
  sourceUserId            String?  @map("source_user_id") @db.Uuid
  sourceAgentType         String?  @map("source_agent_type")
  sourceAutomationRunId   String?  @map("source_automation_run_id") @db.Uuid
  sourceExternal          String?  @map("source_external")
  
  // AI metadata (if AI-generated approval request)
  aiModel         String?            @map("ai_model")
  aiRationale     String?            @map("ai_rationale") @db.Text
  aiConfidence    Float?             @map("ai_confidence")
  aiEvidence      Json?              @map("ai_evidence") // AIEvidence[]
  aiContextIds    String[]           @default([]) @map("ai_context_ids") // RAG chunks used
  
  // Modifications tracking
  modifications   Json?              // Array of {field, original, approved, reason}
  
  status          ApprovalStatus     @default(pending)
  approvedBy      String?            @map("approved_by") @db.Uuid
  approvedAt      DateTime?          @map("approved_at")
  rejectionReason String?            @map("rejection_reason") @db.Text
  callRecordId    String?            @map("call_record_id") @db.Uuid // If created from AI call
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approver   User?       @relation("ApprovedBy", fields: [approvedBy], references: [id])
  callRecord CallRecord? @relation(fields: [callRecordId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([sourceType])
  @@map("approvals")
}

model AuditLog {
  id         String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String         @map("tenant_id") @db.Uuid
  userId     String?        @map("user_id") @db.Uuid
  actorType  AuditActorType @map("actor_type")
  actorId    String         @map("actor_id")
  action     String
  entityType String         @map("entity_type")
  entityId   String?        @map("entity_id") @db.Uuid
  
  // Enhanced fields for HIPAA compliance
  method     String?        // HTTP method (GET, POST, etc.)
  url        String?        // Request URL
  statusCode Int?           @map("status_code")
  duration   Int?           // Request duration in ms
  result     AuditResult    @default(success)
  
  metadata   Json?
  ipAddress  String?        @map("ip_address")
  userAgent  String?        @map("user_agent")
  createdAt  DateTime       @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([action])
  @@map("audit_logs")
}

enum AuditResult {
  success
  failure
  error
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum ApprovalEntityType {
  appointment
  patient
  insurance
  billing
  coding
  claim
  pre_auth
  document
  narrative
  appeal
}

enum AuditActorType {
  user
  ai
  system
}

// ===========================================
// Section 20.5: Documents & AI Context
// ===========================================

model Document {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  patientId   String?      @map("patient_id") @db.Uuid
  type        DocumentType
  fileName    String       @map("file_name")
  mimeType    String       @map("mime_type")
  storageKey  String       @map("storage_key") // S3 key
  contentHash String       @map("content_hash")
  sizeBytes   Int          @map("size_bytes")
  metadata    Json?        // DocumentMetadata
  
  // Creator tracking (critical for audit)
  createdByType        String  @default("user") @map("created_by_type") // 'user' | 'ai_agent' | 'automation' | 'system'
  createdByUserId      String? @map("created_by_user_id") @db.Uuid
  createdByAgentType   String? @map("created_by_agent_type") // Which AI agent created this
  createdByAutomationRunId String? @map("created_by_automation_run_id") @db.Uuid
  
  // AI generation metadata (if applicable)
  aiGenerated          Boolean @default(false) @map("ai_generated")
  aiModel              String? @map("ai_model")
  aiConfidence         Float?  @map("ai_confidence")
  aiRationale          String? @map("ai_rationale") @db.Text
  aiContextIds         String[] @default([]) @map("ai_context_ids") // RAG chunk IDs used
  aiTokensUsed         Json?   @map("ai_tokens_used") // {prompt: number, completion: number}
  
  // Status
  status               DocumentStatus @default(draft)
  
  // Approval (if required)
  approvalId           String? @map("approval_id") @db.Uuid
  
  // Version tracking
  version              Int     @default(1)
  previousVersionId    String? @map("previous_version_id") @db.Uuid
  
  // Timestamps
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  
  // Pre-authorization relation
  preAuthId   String?      @map("pre_auth_id") @db.Uuid
  
  // Claim relation
  claimId     String?      @map("claim_id") @db.Uuid

  // Relations
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient     Patient?         @relation(fields: [patientId], references: [id], onDelete: SetNull)
  preAuth     PreAuthorization? @relation("PreAuthDocuments", fields: [preAuthId], references: [id], onDelete: SetNull)
  ragChunks   RagChunk[]

  @@index([tenantId])
  @@index([patientId])
  @@index([preAuthId])
  @@index([claimId])
  @@index([type, status])
  @@map("documents")
}

enum DocumentStatus {
  draft
  pending_approval
  approved
  rejected
  sent
  archived
}

model RagChunk {
  id         String                      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  documentId String                      @map("document_id") @db.Uuid
  chunkIndex Int                         @map("chunk_index")
  content    String
  embedding  Unsupported("vector(1536)")? // OpenAI ada-002 dimension
  metadata   Json?                       // RagChunkMetadata
  createdAt  DateTime                    @default(now()) @map("created_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("rag_chunks")
}

// Training examples generated from AI feedback
// Used by AI service for RAG-based learning
model TrainingExample {
  id         String                      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId   String                      @map("tenant_id") @db.Uuid
  feedbackId String?                     @map("feedback_id") @db.Uuid
  agentType  String                      @map("agent_type") // CDT_CODER, PA_GENERATOR, etc.
  content    String                      @db.Text
  embedding  Unsupported("vector(1536)")? // OpenAI ada-002 dimension
  weight     Float                       @default(1.0) // Retraining importance
  metadata   Json?                       // Source, outcome, etc.
  createdAt  DateTime                    @default(now()) @map("created_at")
  updatedAt  DateTime                    @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, feedbackId])
  @@index([tenantId, agentType])
  @@index([agentType])
  @@map("training_examples")
}

// ===========================================
// AI Insights
// ===========================================

model AiInsight {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId    String           @map("tenant_id") @db.Uuid
  type        AiInsightType
  title       String
  description String           @db.Text
  confidence  Float
  evidence    Json?
  status      AiInsightStatus  @default(pending)
  entityType  String           @map("entity_type")
  entityId    String?          @map("entity_id") @db.Uuid
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([entityType, entityId])
  @@map("ai_insights")
}

enum AiInsightType {
  coding
  summary
  alert
  recommendation
}

enum AiInsightStatus {
  pending
  approved
  rejected
}

// ===========================================
// Section 20.5.3: AI Feedback for Self-Learning
// ===========================================

model AIFeedbackEvent {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId              String   @map("tenant_id") @db.Uuid
  agentType             String   @map("agent_type") // Which AI agent: 'coding' | 'narrative' | 'appeal' | 'message'
  
  // What was suggested
  suggestionType        String   @map("suggestion_type") // 'code' | 'narrative' | 'appeal' | 'message'
  suggestionContent     Json     @map("suggestion_content")
  suggestionConfidence  Float    @map("suggestion_confidence")
  retrievedContextIds   String[] @default([]) @map("retrieved_context_ids") // RAG chunk IDs used
  
  // What was the outcome
  outcomeAction         String   @map("outcome_action") // 'approved' | 'rejected' | 'modified'
  finalValue            Json?    @map("final_value")
  modificationReason    String?  @map("modification_reason") @db.Text
  
  // External outcome (if applicable)
  externalSuccess       Boolean? @map("external_success")
  externalResponseCode  String?  @map("external_response_code")
  externalResponseMessage String? @map("external_response_message") @db.Text
  
  // Retraining flags
  shouldRetrain         Boolean  @default(true) @map("should_retrain")
  retrainingWeight      Float    @default(1.0) @map("retraining_weight")
  wasRetrained          Boolean  @default(false) @map("was_retrained")
  
  createdAt             DateTime @default(now()) @map("created_at")

  @@index([tenantId, agentType])
  @@index([shouldRetrain, wasRetrained])
  @@index([createdAt])
  @@map("ai_feedback_events")
}

enum DocumentType {
  clinical_note
  treatment_plan
  xray
  insurance_card
  consent_form
  eob
  call_recording
  pre_auth
  appeal_letter
  claim_narrative
  other
}

// ===========================================
// Section 20.5.5: Attachments for Claims & PAs
// ===========================================

model Attachment {
  id               String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String          @map("tenant_id") @db.Uuid
  type             AttachmentType
  description      String?
  
  // Storage
  storageKey       String          @map("storage_key") // S3 key
  fileName         String          @map("file_name")
  mimeType         String          @map("mime_type")
  fileSize         Int             @map("file_size")
  
  // Relations to entities
  claimId          String?         @map("claim_id") @db.Uuid
  preAuthId        String?         @map("pre_auth_id") @db.Uuid
  
  // Stedi attachment reference (for 837D)
  stediAttachmentId String?        @map("stedi_attachment_id")
  transmissionCode  String?        @map("transmission_code") // 'AA' (available), 'BM' (by mail), etc.
  
  // Creator tracking
  createdBy        String          @map("created_by") @db.Uuid
  createdAt        DateTime        @default(now()) @map("created_at")

  // Relations
  claim            Claim?          @relation(fields: [claimId], references: [id], onDelete: SetNull)
  preAuth          PreAuthorization? @relation(fields: [preAuthId], references: [id], onDelete: SetNull)

  @@index([claimId])
  @@index([preAuthId])
  @@index([tenantId])
  @@map("attachments")
}

enum AttachmentType {
  xray
  perio_chart
  clinical_photo
  narrative
  eob
  denial_letter
  appeal_letter
  insurance_card
  other
}

// ===========================================
// AI Voice Agent - Call Records & Transcripts
// ===========================================

model CallRecord {
  id            String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String       @map("tenant_id") @db.Uuid
  
  // Twilio Integration
  twilioCallSid   String?    @unique @map("twilio_call_sid") // Twilio's Call SID
  elevenLabsConversationId String? @map("elevenlabs_conversation_id") // ElevenLabs session ID
  
  patientId     String?      @map("patient_id") @db.Uuid // If patient identified
  
  // Agent Management Integration
  agentConfigId   String?  @map("agent_config_id") @db.Uuid
  phoneNumberId   String?  @map("phone_number_id") @db.Uuid
  
  // Call Details
  phoneNumber   String?      @map("phone_number") // Caller's number (scrubbed for storage)
  callerName    String?      @map("caller_name") // Caller ID name if available
  direction     CallDirection @default(inbound)
  startTime     DateTime     @map("start_time")
  endTime       DateTime?    @map("end_time")
  durationSecs  Int?         @map("duration_secs")
  
  // Routing Information
  routingDecision   String?  @map("routing_decision") // 'ai_handled' | 'forwarded' | 'voicemail' | 'emergency' | 'after_hours'
  routedToNumber    String?  @map("routed_to_number")
  routedToName      String?  @map("routed_to_name")
  wasEmergency      Boolean  @default(false) @map("was_emergency")
  wasAfterHours     Boolean  @default(false) @map("was_after_hours")
  queueWaitSeconds  Int?     @map("queue_wait_seconds")
  
  // Status
  status        CallStatus   @default(in_progress)
  disconnectReason String?   @map("disconnect_reason")
  
  // Outcome
  intent        String?      // Primary detected intent
  outcome       CallOutcome?
  appointmentId String?      @map("appointment_id") @db.Uuid // If appointment was booked
  transferredTo String?      @map("transferred_to") // If transferred to human
  
  // Call Quality Metrics
  qualityScore    Float?   @map("quality_score") // 0-10
  userSatisfaction Int?    @map("user_satisfaction") // 1-5 stars
  wasEscalated    Boolean  @default(false) @map("was_escalated")
  escalationReason String? @map("escalation_reason")
  
  // Analysis
  sentiment     CallSentiment?
  summary       String?      @db.Text // AI-generated summary
  
  // Audio (optional)
  recordingUrl  String?      @map("recording_url") // S3/Twilio URL
  recordingKey  String?      @map("recording_key") // S3 key
  recordingSid  String?      @map("recording_sid") // Twilio Recording SID
  
  // Metadata
  metadata      Json?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  patient       Patient?     @relation(fields: [patientId], references: [id], onDelete: SetNull)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  agentConfig   AgentConfig? @relation(fields: [agentConfigId], references: [id], onDelete: SetNull)
  phoneNumberRecord PhoneNumber? @relation(fields: [phoneNumberId], references: [id], onDelete: SetNull)
  transcripts   CallTranscript[]
  toolCalls     CallToolInvocation[]
  approvals     Approval[]

  @@index([tenantId])
  @@index([patientId])
  @@index([agentConfigId])
  @@index([phoneNumberId])
  @@index([startTime])
  @@index([status])
  @@map("call_records")
}

model CallTranscript {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  callId      String   @map("call_id") @db.Uuid
  
  // Utterance
  sequence    Int      // Order in conversation
  role        String   // "agent" or "user"
  content     String   @db.Text
  contentScrubbed String? @map("content_scrubbed") @db.Text // PII removed version
  
  // Timing
  timestamp   DateTime @default(now())
  
  // Analysis
  intent      String?
  confidence  Float?
  
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  call CallRecord @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([sequence])
  @@map("call_transcripts")
}

model CallToolInvocation {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  callId       String   @map("call_id") @db.Uuid
  
  // Tool Details
  toolName     String   @map("tool_name")
  arguments    Json?
  result       Json?
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")
  
  // Timing
  invokedAt    DateTime @map("invoked_at")
  completedAt  DateTime? @map("completed_at")
  durationMs   Int?     @map("duration_ms")
  
  // Approval (if created)
  approvalId   String?  @map("approval_id") @db.Uuid
  
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  call CallRecord @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([toolName])
  @@map("call_tool_invocations")
}

// ===========================================
// Section: Agent Management (NEW - Phase 1)
// ===========================================

// Phone Number Management
model PhoneNumber {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  
  // Phone Details
  phoneNumber   String   @map("phone_number") // E.164 format: +15551234567
  friendlyName  String?  @map("friendly_name")
  provider      PhoneProvider
  providerSid   String?  @map("provider_sid") // Twilio/Telnyx ID
  
  // Configuration
  status        PhoneStatus  @default(INACTIVE)
  assignedAgentId String?   @map("assigned_agent_id") @db.Uuid
  
  // Capabilities
  voiceEnabled  Boolean  @default(true) @map("voice_enabled")
  smsEnabled    Boolean  @default(false) @map("sms_enabled")
  
  // Metadata
  purchasedAt   DateTime? @map("purchased_at")
  activatedAt   DateTime? @map("activated_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agent         AgentConfig? @relation(fields: [assignedAgentId], references: [id])
  calls         CallRecord[]
  
  @@index([tenantId])
  @@index([phoneNumber])
  @@index([status])
  @@map("phone_numbers")
}

// AI Agent Configuration
model AgentConfig {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  
  // Agent Identity
  agentName       String   @map("agent_name")
  agentCategory   AgentCategory @default(VOICE) @map("agent_category")
  agentType       AgentType @default(VOICE_RECEPTIONIST)
  
  // Voice Agent (ElevenLabs Integration) - Nullable for automation agents
  elevenLabsAgentId String?  @unique @map("elevenlabs_agent_id") // From ElevenLabs Conversational AI
  voiceId         String?  @map("voice_id") @default("eleven_labs_rachel")
  language        String   @default("en-US")
  
  // ============================================
  // Call Routing Configuration
  // ============================================
  
  // Business Hours Management
  workingHours    Json?    @map("working_hours") @db.JsonB // {enabled, timezone, schedule: {monday: {enabled, open, close, lunchStart, lunchEnd}, ...}, holidays: [{date, name, emergencyOnly}]}
  
  // Routing Numbers
  fallbackNumber        String?  @map("fallback_number") @db.VarChar(20)      // When agent offline/unavailable
  afterHoursNumber      String?  @map("after_hours_number") @db.VarChar(20)   // Outside business hours
  emergencyNumber       String?  @map("emergency_number") @db.VarChar(20)     // 24/7 emergency line
  transferNumbers       Json?    @map("transfer_numbers") @db.JsonB           // [{name, number, role, priority, available}]
  
  // Call Queue Settings  
  callQueueEnabled      Boolean  @default(false) @map("call_queue_enabled")
  maxQueueSize          Int      @default(5) @map("max_queue_size")
  maxQueueWaitSeconds   Int      @default(300) @map("max_queue_wait_seconds")  // 5 minutes default
  
  // Overflow Handling
  overflowAction        String?  @map("overflow_action") @db.VarChar(20)      // 'voicemail' | 'forward' | 'callback'
  overflowNumber        String?  @map("overflow_number") @db.VarChar(20)      // Number to forward on overflow
  
  // Emergency Detection
  emergencyKeywords     String[] @default(["emergency", "urgent", "severe pain", "bleeding", "swelling", "trauma", "accident"]) @map("emergency_keywords")
  emergencyBypass       Boolean  @default(true) @map("emergency_bypass")       // Bypass queue for emergencies
  
  // Routing Statistics
  totalCallsRouted      Int      @default(0) @map("total_calls_routed")
  emergencyCallsRouted  Int      @default(0) @map("emergency_calls_routed")
  fallbackRoutedCalls   Int      @default(0) @map("fallback_routed_calls")
  afterHoursRoutedCalls Int      @default(0) @map("after_hours_routed_calls")
  
  // Legacy field (kept for migration compatibility)
  transferNumber  String?  @map("transfer_number") // Human fallback - DEPRECATED, use transferNumbers
  
  // ============================================
  // Automation Agent - Nullable for voice agents
  // ============================================
  executionSchedule String? @map("execution_schedule") // Cron expression
  batchSize       Int?     @map("batch_size") // For batch processing
  priority        Int?     @default(5) // 1-10 priority level
  triggerModes    Json?    @map("trigger_modes") // ["always_on", "scheduled", "manual"]
  lastRunAt       DateTime? @map("last_run_at")
  nextRunAt       DateTime? @map("next_run_at")
  
  // Status
  status          AgentStatus @default(INACTIVE)
  isActive        Boolean  @default(false) @map("is_active")
  
  // Common Configuration
  customPrompt    String?  @map("custom_prompt") @db.Text
  beginMessage    String?  @map("begin_message") @db.Text
  
  // Guardrails
  requireApproval Boolean  @default(true) @map("require_approval")
  maxCallDuration Int      @default(1800) @map("max_call_duration") // seconds
  
  // Metadata
  activatedAt     DateTime? @map("activated_at")
  lastActiveAt    DateTime? @map("last_active_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdBy       String?   @map("created_by") @db.Uuid
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phoneNumbers    PhoneNumber[]
  calls           CallRecord[]
  automationRuns  AutomationRun[]
  
  @@index([tenantId])
  @@index([agentCategory, status])
  @@index([isActive])
  @@map("agent_configs")
}

// Automation Agent Execution History
model AutomationRun {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  agentConfigId   String   @map("agent_config_id") @db.Uuid
  
  // Execution Details
  status          AutomationRunStatus
  startedAt       DateTime @map("started_at")
  completedAt     DateTime? @map("completed_at")
  
  // Results
  itemsProcessed  Int      @default(0) @map("items_processed")
  itemsSucceeded  Int      @default(0) @map("items_succeeded")
  itemsFailed     Int      @default(0) @map("items_failed")
  
  // Error Tracking
  error           String?  @db.Text
  logs            Json?    // Detailed execution logs
  
  // Metadata
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentConfig     AgentConfig @relation(fields: [agentConfigId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, agentConfigId])
  @@index([status, startedAt])
  @@map("automation_runs")
}

enum AutomationRunStatus {
  running
  completed
  failed
  cancelled
}

// Retell Agent Configuration per Tenant (LEGACY - Keep for backward compatibility)
model RetellAgent {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String   @unique @map("tenant_id") @db.Uuid
  retellAgentId   String   @unique @map("retell_agent_id") // Retell's agent ID
  
  // Configuration
  agentName       String   @map("agent_name")
  voiceId         String?  @map("voice_id") // 11labs voice ID
  language        String   @default("en-US")
  
  // Custom LLM
  llmWebsocketUrl String   @map("llm_websocket_url")
  
  // Phone
  phoneNumber     String?  @map("phone_number") // Assigned Retell phone number
  phoneNumberId   String?  @map("phone_number_id")
  
  // Settings
  beginMessage    String?  @map("begin_message") @db.Text
  generalPrompt   String?  @map("general_prompt") @db.Text
  
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("retell_agents")
}

enum CallDirection {
  inbound
  outbound
}

enum CallStatus {
  in_progress
  completed
  transferred
  failed
  voicemail
}

enum CallOutcome {
  appointment_booked
  appointment_rescheduled
  appointment_cancelled
  information_provided
  transferred_to_human
  voicemail_left
  abandoned
  other
}

enum CallSentiment {
  positive
  neutral
  negative
  frustrated
}

// ===========================================
// PMS Mapping Tables
// ===========================================

model PmsMapping {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  pmsSource    PmsSource @map("pms_source")
  entityType   String    @map("entity_type")
  pmsId        String    @map("pms_id")
  crownDeskId  String    @map("crowndesk_id") @db.Uuid
  lastSyncedAt DateTime  @map("last_synced_at")
  syncStatus   SyncStatus @default(synced) @map("sync_status")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pmsSource, entityType, pmsId])
  @@index([crownDeskId])
  @@map("pms_mappings")
}

enum SyncStatus {
  synced
  pending
  error
}

// ===========================================
// Usage & Billing Ledger
// ===========================================

model UsageLedger {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String    @map("tenant_id") @db.Uuid
  usageType        UsageType @map("usage_type")
  quantity         Int
  unitCost         Decimal?  @map("unit_cost") @db.Decimal(10, 4)
  metadata         Json?
  recordedAt       DateTime  @default(now()) @map("recorded_at")
  reportedToStripe Boolean   @default(false) @map("reported_to_stripe")
  stripeEventId    String?   @map("stripe_event_id")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, recordedAt])
  @@index([reportedToStripe])
  @@map("usage_ledger")
}

enum UsageType {
  ai_intent
  ai_summary
  ai_coding
  eligibility_check
  call_minute
  document_processed
}

// ===========================================
// Sync Watermarks
// ===========================================

model SyncWatermark {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  pmsSource    PmsSource @map("pms_source")
  entityType   String    @map("entity_type")
  lastSyncedAt DateTime  @map("last_synced_at")
  lastPmsId    String?   @map("last_pms_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, pmsSource, entityType])
  @@map("sync_watermarks")
}

// ===========================================
// Section 5: Claims Processing (837D/835)
// ===========================================

// Insurance Payment (for payment posting)
model InsurancePayment {
  id                 String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String                @map("tenant_id") @db.Uuid
  
  // Payment Source
  paymentType        InsurancePaymentType  @default(insurance) @map("payment_type")
  payerId            String?               @map("payer_id") @db.Uuid // InsurancePolicy.insurerId
  patientId          String?               @map("patient_id") @db.Uuid
  
  // Payment Details
  paymentDate        DateTime              @map("payment_date") @db.Date
  paymentMethod      PaymentMethod         @map("payment_method")
  checkNumber        String?               @map("check_number")
  referenceNumber    String?               @map("reference_number") // EFT trace number
  totalAmount        Decimal               @map("total_amount") @db.Decimal(10, 2)
  
  // ERA (835) Info
  eraId              String?               @map("era_id")
  eftTraceNumber     String?               @map("eft_trace_number")
  
  // Matching Status
  matchStatus        PaymentMatchStatus    @default(unmatched) @map("match_status")
  matchedAt          DateTime?             @map("matched_at")
  matchedBy          String?               @map("matched_by")
  
  // Posting
  postedBy           String?               @map("posted_by")
  postedAt           DateTime?             @map("posted_at")
  notes              String?               @db.Text
  
  // Timestamps
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")

  // Relations
  postings           ClaimPaymentPosting[]

  @@index([tenantId])
  @@index([payerId])
  @@index([patientId])
  @@index([matchStatus])
  @@index([referenceNumber])
  @@index([checkNumber])
  @@map("insurance_payments")
}

// Individual claim payment posting (line-level detail)
model ClaimPaymentPosting {
  id                   String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  insurancePaymentId   String            @map("insurance_payment_id") @db.Uuid
  claimId              String            @map("claim_id") @db.Uuid
  claimProcedureId     String?           @map("claim_procedure_id") @db.Uuid
  
  // Payment Amounts
  paidAmount           Decimal           @map("paid_amount") @db.Decimal(10, 2)
  allowedAmount        Decimal?          @map("allowed_amount") @db.Decimal(10, 2)
  adjustmentAmount     Decimal?          @map("adjustment_amount") @db.Decimal(10, 2)
  patientResponsibility Decimal?         @map("patient_responsibility") @db.Decimal(10, 2)
  
  // CARC/RARC Codes (X12 835 adjustment reason codes)
  adjustmentGroupCode  String?           @map("adjustment_group_code") // CO, PR, PI, CR, OA
  adjustmentReasonCode String?           @map("adjustment_reason_code") // CARC code (1-300+)
  remarkCodes          String[]          @map("remark_codes") // RARC codes
  
  // Timestamps
  createdAt            DateTime          @default(now()) @map("created_at")

  // Relations
  insurancePayment     InsurancePayment  @relation(fields: [insurancePaymentId], references: [id], onDelete: Cascade)

  @@index([insurancePaymentId])
  @@index([claimId])
  @@index([claimProcedureId])
  @@map("claim_payment_postings")
}

enum InsurancePaymentType {
  insurance
  patient
  other
}

enum PaymentMatchStatus {
  unmatched
  partial
  matched
  manual
}

model Claim {
  id                 String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String      @map("tenant_id") @db.Uuid
  patientId          String      @map("patient_id") @db.Uuid
  insurancePolicyId  String      @map("insurance_policy_id") @db.Uuid
  appointmentId      String?     @map("appointment_id") @db.Uuid
  
  // Claim Info
  claimNumber        String?     @map("claim_number")
  claimType          ClaimType   @default(professional) @map("claim_type")
  
  // Service Details
  dateOfService      DateTime    @map("date_of_service") @db.Date
  totalCharge        Decimal     @map("total_charge") @db.Decimal(10, 2)
  
  // Provider
  renderingProviderId String?    @map("rendering_provider_id")
  billingProviderId   String?    @map("billing_provider_id")
  
  // Status Tracking
  status             ClaimStatus @default(draft)
  submittedAt        DateTime?   @map("submitted_at")
  adjudicatedAt      DateTime?   @map("adjudicated_at")
  
  // Payment Info
  allowedAmount      Decimal?    @map("allowed_amount") @db.Decimal(10, 2)
  paidAmount         Decimal?    @map("paid_amount") @db.Decimal(10, 2)
  patientResponsibility Decimal? @map("patient_responsibility") @db.Decimal(10, 2)
  
  // ERA (835)
  eraId              String?     @map("era_id")
  checkNumber        String?     @map("check_number")
  paymentDate        DateTime?   @map("payment_date") @db.Date
  eraRawResponse     Json?       @map("era_raw_response")
  
  // Denial/Appeal
  denialReason       String?     @map("denial_reason")
  denialCode         String?     @map("denial_code")
  appealStatus       AppealStatus @default(none) @map("appeal_status")
  appealDate         DateTime?   @map("appeal_date") @db.Date
  
  // Clinical Narrative (for medical necessity documentation)
  narrative          String?     @db.Text // Clinical narrative for claim
  narrativeSource    String      @default("manual") @map("narrative_source") // 'manual' | 'ai'
  narrativeProcedureIds String[] @map("narrative_procedure_ids") // Which procedures the narrative covers
  
  // EDI
  stediClaimId       String?     @map("stedi_claim_id")
  ediPayload         Json?       @map("edi_payload")
  
  // Pre-Authorization reference
  preAuthId          String?     @map("pre_auth_id") @db.Uuid
  
  // Timestamps
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relations
  patient            Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  insurancePolicy    InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id])
  preAuth            PreAuthorization? @relation(fields: [preAuthId], references: [id], onDelete: SetNull)
  procedures         ClaimProcedure[]
  completedProcedures CompletedProcedure[]
  attachments        Attachment[]

  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@index([dateOfService])
  @@index([preAuthId])
  @@map("claims")
}

model ClaimProcedure {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  claimId      String   @map("claim_id") @db.Uuid
  cdtCode      String   @map("cdt_code")
  description  String
  toothNumbers String[] @map("tooth_numbers")
  surfaces     String[]
  fee          Decimal  @db.Decimal(10, 2)
  quantity     Int      @default(1)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  claim Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@map("claim_procedures")
}

enum ClaimType {
  professional
  institutional
}

enum ClaimStatus {
  draft
  pending_submission
  submitted
  acknowledged
  pending
  accepted
  rejected
  paid
  partially_paid
  denied
  appealed
}

enum AppealStatus {
  none
  pending
  approved
  denied
}

// ===========================================
// Section 6: Treatment Plans
// ===========================================

model TreatmentPlan {
  id                 String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String              @map("tenant_id") @db.Uuid
  patientId          String              @map("patient_id") @db.Uuid
  
  // Plan Info
  name               String
  description        String?
  status             TreatmentPlanStatus @default(draft)
  
  // Provider
  providerId         String?             @map("provider_id")
  presentedAt        DateTime?           @map("presented_at")
  acceptedAt         DateTime?           @map("accepted_at")
  
  // Financial
  totalFee           Decimal             @map("total_fee") @db.Decimal(10, 2)
  insuranceEstimate  Decimal?            @map("insurance_estimate") @db.Decimal(10, 2)
  patientEstimate    Decimal?            @map("patient_estimate") @db.Decimal(10, 2)
  
  // Timestamps
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  completedAt        DateTime?           @map("completed_at")

  // Relations
  patient            Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  phases             TreatmentPhase[]
  preAuthorizations  PreAuthorization[]

  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@map("treatment_plans")
}

model TreatmentPhase {
  id               String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  treatmentPlanId  String           @map("treatment_plan_id") @db.Uuid
  phaseNumber      Int              @map("phase_number")
  name             String
  
  // Priority
  priority         PhasePriority    @default(medium)
  estimatedDuration Int?            @map("estimated_duration") // minutes
  
  // Status
  status           PhaseStatus      @default(pending)
  scheduledAppointmentId String?    @map("scheduled_appointment_id") @db.Uuid
  completedAt      DateTime?        @map("completed_at")
  
  // Timestamps
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  treatmentPlan    TreatmentPlan    @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  procedures       PlannedProcedure[]

  @@index([treatmentPlanId])
  @@map("treatment_phases")
}

model PlannedProcedure {
  id               String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  phaseId          String         @map("phase_id") @db.Uuid
  cdtCode          String         @map("cdt_code")
  description      String
  toothNumbers     String[]       @map("tooth_numbers")
  surfaces         String[]
  fee              Decimal        @db.Decimal(10, 2)
  insuranceCoverage Decimal?      @map("insurance_coverage") @db.Decimal(10, 2)
  patientPortion   Decimal?       @map("patient_portion") @db.Decimal(10, 2)
  createdAt        DateTime       @default(now()) @map("created_at")

  // Relations
  phase TreatmentPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@map("planned_procedures")
}

enum TreatmentPlanStatus {
  draft
  presented
  accepted
  in_progress
  completed
  declined
}

enum PhaseStatus {
  pending
  in_progress
  completed
}

enum PhasePriority {
  urgent
  high
  medium
  low
}

// ===========================================
// Section 6.5: Completed Procedures (synced from PMS)
// ===========================================

// Procedures completed by doctors in the PMS (Open Dental)
// This is synced FROM the PMS and used for billing/claims
model CompletedProcedure {
  id               String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String            @map("tenant_id") @db.Uuid
  patientId        String            @map("patient_id") @db.Uuid
  appointmentId    String?           @map("appointment_id") @db.Uuid
  
  // Procedure Details
  cdtCode          String            @map("cdt_code")
  description      String
  procDate         DateTime          @map("proc_date") @db.Date
  toothNumber      String?           @map("tooth_number")
  surface          String?
  fee              Decimal           @db.Decimal(10, 2)
  status           ProcedureStatus   @default(completed)
  
  // Provider
  providerId       String?           @map("provider_id") @db.Uuid
  providerName     String?           @map("provider_name")
  
  // Clinical Notes (from doctor)
  note             String?
  diagCode         String?           @map("diag_code")
  
  // Billing Status
  billingStatus    ProcedureBillingStatus @default(unbilled) @map("billing_status")
  claimId          String?           @map("claim_id") @db.Uuid
  invoiceId        String?           @map("invoice_id") @db.Uuid
  
  // PMS Sync
  pmsSource        String?           @map("pms_source") // 'open_dental'
  pmsProcedureId   String?           @map("pms_procedure_id")
  lastSyncedAt     DateTime?         @map("last_synced_at")
  
  // Timestamps
  dateComplete     DateTime?         @map("date_complete")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  providerRef      Provider?         @relation(fields: [providerId], references: [id])
  claim            Claim?            @relation(fields: [claimId], references: [id])
  invoice          Invoice?          @relation(fields: [invoiceId], references: [id])

  @@unique([tenantId, pmsProcedureId, pmsSource])
  @@index([tenantId])
  @@index([patientId])
  @@index([procDate])
  @@index([billingStatus])
  @@map("completed_procedures")
}

enum ProcedureStatus {
  treatment_planned
  completed
  existing_current
  existing_other
  referred_out
  deleted
  condition
  estimate
}

enum ProcedureBillingStatus {
  unbilled
  pending_claim
  claimed
  paid
  denied
  write_off
}

// ===========================================
// Section 7: Billing & Invoices
// ===========================================

model Invoice {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId         String        @map("tenant_id") @db.Uuid
  patientId        String        @map("patient_id") @db.Uuid
  
  // Invoice Details
  invoiceNumber    String        @map("invoice_number")
  invoiceDate      DateTime      @map("invoice_date") @db.Date
  dueDate          DateTime      @map("due_date") @db.Date
  
  // Amounts
  subtotal         Decimal       @db.Decimal(10, 2)
  taxAmount        Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount   Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount      Decimal       @map("total_amount") @db.Decimal(10, 2)
  
  // Insurance Applied
  insuranceApplied Decimal       @default(0) @map("insurance_applied") @db.Decimal(10, 2)
  patientBalance   Decimal       @map("patient_balance") @db.Decimal(10, 2)
  
  // Status
  status           InvoiceStatus @default(draft)
  
  // Payment Tracking
  amountPaid       Decimal       @default(0) @map("amount_paid") @db.Decimal(10, 2)
  amountDue        Decimal       @map("amount_due") @db.Decimal(10, 2)
  
  // Related
  treatmentPlanId  String?       @map("treatment_plan_id") @db.Uuid
  
  // Communication
  sentAt           DateTime?     @map("sent_at")
  sentMethod       String?       @map("sent_method")
  
  // Creator tracking (critical for audit and source attribution)
  createdByType    String        @default("user") @map("created_by_type") // 'user' | 'automation' | 'system'
  createdByUserId  String?       @map("created_by_user_id") @db.Uuid
  createdByAutomationRunId String? @map("created_by_automation_run_id") @db.Uuid
  notes            String?       @db.Text
  
  // Timestamps
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  patient          Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  lineItems        InvoiceLineItem[]
  payments         Payment[]
  completedProcedures CompletedProcedure[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  invoiceId    String   @map("invoice_id") @db.Uuid
  description  String
  cdtCode      String?  @map("cdt_code")
  quantity     Int      @default(1)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount       Decimal  @db.Decimal(10, 2)
  
  // Claim linking (for tracking which claim this line item relates to)
  claimId      String?  @map("claim_id") @db.Uuid
  
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([claimId])
  @@map("invoice_line_items")
}

model Payment {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String        @map("tenant_id") @db.Uuid
  invoiceId       String        @map("invoice_id") @db.Uuid
  
  // Payment Details
  amount          Decimal       @db.Decimal(10, 2)
  method          PaymentMethod
  referenceNumber String?       @map("reference_number")
  paymentDate     DateTime      @map("payment_date") @db.Date
  
  // Stripe
  stripePaymentId String?       @map("stripe_payment_id")
  
  // User
  postedBy        String        @map("posted_by")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tenantId])
  @@map("payments")
}

enum InvoiceStatus {
  draft
  sent
  paid
  partial
  overdue
  void
}

enum PaymentMethod {
  cash
  check
  credit_card
  ach
  insurance
  other
}

// ===========================================
// Section 8: Procedure Codes (CDT)
// ===========================================

model ProcedureCode {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String?      @map("tenant_id") @db.Uuid // null = system-wide
  
  // Code Info
  code            String       // e.g., 'D0120'
  category        CDTCategory
  description     String
  abbreviation    String?
  
  // Fee Schedule
  defaultFee      Decimal      @map("default_fee") @db.Decimal(10, 2)
  
  // Insurance
  typicalCoverage Int?         @map("typical_coverage") // percentage, e.g., 80
  frequencyLimit  String?      @map("frequency_limit") // e.g., '2 per year'
  
  // Clinical
  typicalDuration Int?         @map("typical_duration") // minutes
  isActive        Boolean      @default(true) @map("is_active")
  
  // Metadata
  version         String       @default("2026")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@unique([tenantId, code])
  @@index([code])
  @@index([category])
  @@map("procedure_codes")
}

enum CDTCategory {
  diagnostic
  preventive
  restorative
  endodontics
  periodontics
  prosthodontics_removable
  prosthodontics_fixed
  oral_surgery
  orthodontics
  adjunctive
}

// ===========================================
// Agent Management Enums (NEW - Phase 1)
// ===========================================

enum PhoneProvider {
  TWILIO
  TELNYX
  VONAGE
  SIP_TRUNK
  OTHER
}

enum PhoneStatus {
  INACTIVE      // Purchased but not configured
  ACTIVE        // Live and receiving calls
  SUSPENDED     // Temporarily disabled
  PORTING       // Number port in progress
  RELEASED      // Released back to provider
}

enum AgentCategory {
  VOICE         // Phone-based agents (Twilio + ElevenLabs)
  AUTOMATION    // Backend automation agents
}

enum AgentType {
  // Voice Agents (Phone/Call handling)
  VOICE_RECEPTIONIST  // Main voice assistant
  VOICE_SCHEDULER     // Appointment-only agent
  VOICE_EMERGENCY     // After-hours emergency triage
  VOICE_FOLLOWUP      // Patient outreach calls
  
  // Automation Agents (Backend tasks)
  INSURANCE_VERIFIER  // Real-time eligibility checks
  CLAIMS_PROCESSOR    // 837D submission & tracking
  CODING_ASSISTANT    // CDT code suggestions
  BILLING_AUTOMATOR   // Invoice generation & follow-up
  TREATMENT_PLANNER   // Treatment plan optimization
  DENIAL_ANALYZER     // Claim denial resolution
  PAYMENT_COLLECTOR   // AR follow-up automation
  APPOINTMENT_OPTIMIZER // Schedule optimization
  
  // Custom
  CUSTOM              // Custom configured agent
}

enum AgentStatus {
  INACTIVE        // Not started
  ACTIVE          // Running and ready
  ON_CALL         // Currently in a call
  PAUSED          // Temporarily paused
  ERROR           // Configuration error
}

// ===========================================
// Section: Patient Voice Registration (Hybrid System)
// ===========================================

model RegistrationToken {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String    @map("tenant_id") @db.Uuid
  
  // Voice-collected data (pre-filled in form)
  phone           String
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  dateOfBirth     DateTime  @map("date_of_birth") @db.Date
  reasonForVisit  String?   @map("reason_for_visit")
  
  // Call context
  callId          String?   @map("call_id")
  agentId         String?   @map("agent_id") @db.Uuid
  
  // Token lifecycle
  token           String    @unique
  expiresAt       DateTime  @map("expires_at")
  usedAt          DateTime? @map("used_at")
  
  // Security
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  
  // Result
  patientId       String?   @map("patient_id") @db.Uuid
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([tenantId])
  @@index([phone])
  @@index([expiresAt])
  @@index([token])
  @@map("registration_tokens")
}

model PatientRegistrationStage {
  id              String             @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId        String             @map("tenant_id") @db.Uuid
  patientId       String?            @map("patient_id") @db.Uuid
  registrationTokenId String?        @map("registration_token_id") @db.Uuid
  
  // Stage tracking
  stage           RegistrationStage  @default(voice_intake)
  
  // Voice intake data
  voiceCallId     String?            @map("voice_call_id")
  voiceTranscript String?            @map("voice_transcript") @db.Text
  
  // Form progress
  formStartedAt   DateTime?          @map("form_started_at")
  formCompletedAt DateTime?          @map("form_completed_at")
  formData        Json?              @map("form_data") // Partial form data for resume
  
  // Completion
  completedAt     DateTime?          @map("completed_at")
  
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  @@index([tenantId])
  @@index([patientId])
  @@index([stage])
  @@map("patient_registration_stages")
}

enum RegistrationStage {
  voice_intake      // Call started, collecting basic info
  sms_sent          // Registration link sent via SMS
  form_started      // Patient opened the form
  form_incomplete   // Patient started but didn't finish
  form_submitted    // Patient submitted the form
  verified          // Staff verified the registration
  completed         // Full registration complete
}

// ===========================================
// Section 12: Automation Agent Work Items
// ===========================================

// Coding Task - AI-suggested CDT codes for review
model CodingTask {
  id                   String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId             String            @map("tenant_id") @db.Uuid
  completedProcedureId String            @map("completed_procedure_id") @db.Uuid
  automationRunId      String?           @map("automation_run_id") @db.Uuid
  
  // Clinical Input
  clinicalNotes        String?           @map("clinical_notes") @db.Text
  originalCdtCode      String?           @map("original_cdt_code")
  
  // AI Suggestions
  suggestedCodes       Json              @map("suggested_codes") // [{code, description, confidence, reasoning}]
  llmModel             String?           @map("llm_model") @default("gpt-4")
  llmResponse          Json?             @map("llm_response") // Raw LLM response for debugging
  
  // Review
  status               CodingTaskStatus  @default(pending_review)
  reviewedBy           String?           @map("reviewed_by") @db.Uuid
  reviewedAt           DateTime?         @map("reviewed_at")
  
  // Final Selection
  selectedCode         String?           @map("selected_code")
  selectedReason       String?           @map("selected_reason") @db.Text
  
  // Timestamps
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  
  @@unique([tenantId, completedProcedureId])
  @@index([tenantId, status])
  @@index([createdAt])
  @@map("coding_tasks")
}

enum CodingTaskStatus {
  pending_review
  approved
  rejected
  modified
}

// Denial Analysis - AI analysis of denied claims
model DenialAnalysis {
  id                 String                @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId           String                @map("tenant_id") @db.Uuid
  claimId            String                @unique @map("claim_id") @db.Uuid
  automationRunId    String?               @map("automation_run_id") @db.Uuid
  
  // Denial Information
  denialCodes        Json                  @map("denial_codes") // [{code, description}]
  denialDate         DateTime?             @map("denial_date") @db.Date
  
  // AI Analysis
  rootCause          String                @map("root_cause") @db.Text
  suggestedActions   Json                  @map("suggested_actions") // [{action, priority, description}]
  appealLikelihood   String                @map("appeal_likelihood") // high, medium, low
  appealDraft        String?               @map("appeal_draft") @db.Text
  
  // LLM Details
  llmModel           String?               @map("llm_model") @default("gpt-4")
  llmResponse        Json?                 @map("llm_response")
  
  // Review
  status             DenialAnalysisStatus  @default(pending_review)
  reviewedBy         String?               @map("reviewed_by") @db.Uuid
  reviewedAt         DateTime?             @map("reviewed_at")
  
  // Appeal Tracking
  appealPreparedAt   DateTime?             @map("appeal_prepared_at")
  appealSubmittedAt  DateTime?             @map("appeal_submitted_at")
  appealOutcome      String?               @map("appeal_outcome")
  
  // Timestamps
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  
  @@index([tenantId, status])
  @@index([createdAt])
  @@map("denial_analyses")
}

enum DenialAnalysisStatus {
  pending_review
  approved
  appealing
  resubmitting
  appeal_won
  appeal_lost
  closed
}

// Payment Reminder - Track sent reminders
model PaymentReminder {
  id             String                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId       String                 @map("tenant_id") @db.Uuid
  invoiceId      String                 @map("invoice_id") @db.Uuid
  patientId      String                 @map("patient_id") @db.Uuid
  automationRunId String?               @map("automation_run_id") @db.Uuid
  
  // Reminder Details
  reminderType   ReminderType           @map("reminder_type")
  channel        ReminderChannel
  
  // Content
  subject        String?
  body           String?                @db.Text
  
  // Delivery
  sentAt         DateTime?              @map("sent_at")
  deliveredAt    DateTime?              @map("delivered_at")
  failedAt       DateTime?              @map("failed_at")
  failureReason  String?                @map("failure_reason")
  
  // Response
  openedAt       DateTime?              @map("opened_at")
  clickedAt      DateTime?              @map("clicked_at")
  paidAt         DateTime?              @map("paid_at")
  
  // Timestamps
  createdAt      DateTime               @default(now()) @map("created_at")
  
  @@index([tenantId, invoiceId])
  @@index([sentAt])
  @@map("payment_reminders")
}

enum ReminderType {
  first_reminder     // 30 days overdue
  second_reminder    // 60 days overdue
  final_notice       // 90+ days overdue
  pre_collection     // Before sending to collections
}

enum ReminderChannel {
  email
  sms
  portal
  phone
}

// Appointment Optimization Suggestion
model AppointmentSuggestion {
  id                String                    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tenantId          String                    @map("tenant_id") @db.Uuid
  automationRunId   String?                   @map("automation_run_id") @db.Uuid
  
  // Slot to Fill
  slotDate          DateTime                  @map("slot_date") @db.Date
  slotTime          String                    @map("slot_time")
  slotDuration      Int                       @map("slot_duration") // minutes
  providerId        String?                   @map("provider_id") @db.Uuid
  
  // Reason for Opening
  openingReason     SlotOpeningReason         @map("opening_reason")
  originalApptId    String?                   @map("original_appt_id") @db.Uuid
  
  // Candidate Patient
  candidatePatientId String                   @map("candidate_patient_id") @db.Uuid
  candidateReason   String?                   @map("candidate_reason") // recall_due, waitlist, flexible
  candidateScore    Int?                      @map("candidate_score") // 1-100 priority score
  
  // Outreach
  status            SuggestionStatus          @default(pending)
  contactAttempts   Int                       @default(0) @map("contact_attempts")
  lastContactAt     DateTime?                 @map("last_contact_at")
  contactMethod     String?                   @map("contact_method") // phone, sms, email
  
  // Outcome
  outcome           SuggestionOutcome?
  newAppointmentId  String?                   @map("new_appointment_id") @db.Uuid
  
  // Timestamps
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  
  @@index([tenantId, status])
  @@index([slotDate])
  @@map("appointment_suggestions")
}

enum SlotOpeningReason {
  cancellation
  no_show
  gap_detected
  recall_campaign
}

enum SuggestionStatus {
  pending
  contacting
  contacted
  accepted
  declined
  no_response
  expired
}

enum SuggestionOutcome {
  booked
  declined
  rescheduled_later
  no_answer
  wrong_number
  not_interested
}
